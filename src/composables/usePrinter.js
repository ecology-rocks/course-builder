import { nextTick } from 'vue'

export function usePrinter(store, userStore, stageRef, scale) {
  
  async function handlePrint(withHides = true) {
    const originalScale = scale.value
    scale.value = 40 // Force standard print resolution
    await nextTick()
    const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms))
    await wait(100) 

    const d = new Date().toLocaleDateString()
    const logoHtml = userStore.clubLogoUrl ? `<img src="${userStore.clubLogoUrl}" class="print-logo" />` : ''
    const clubHtml = userStore.clubName ? `<div class="meta"><strong>Club:</strong> ${userStore.clubName}</div>` : ''

    // Shared Header
    const getHeader = (subtitleSuffix = '') => `
      <div class="header">
        <div class="header-left">
          ${logoHtml}
          <div class="title-block">
            <h1>${store.mapName}</h1>
            <h2>${store.classLevel} ${store.sport === 'agility' ? 'Agility' : 'Barn Hunt'} ${subtitleSuffix}</h2>
          </div>
        </div>
        <div class="header-right">
          <div class="meta"><strong>Judge:</strong> ${userStore.judgeName || '__________________'}</div>
          ${clubHtml}
          <div class="meta"><strong>Date:</strong> ${d}</div>
          <div class="meta"><strong>Size:</strong> ${store.ringDimensions.width}' x ${store.ringDimensions.height}'</div>
          <div class="sub-meta">Generated by K9CourseBuilder.com</div>
        </div>
      </div>
    `

    // Shared CSS
    const printStyles = `
      @page { size: landscape; margin: 0.25in; }
      html, body { margin: 0; padding: 0; width: 100%; }
      body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #333; }
      .print-page { height: 98vh; width: 100%; display: flex; flex-direction: column; break-after: page; page-break-after: always; }
      .print-page:last-child { break-after: auto; page-break-after: auto; }
      .header { flex: 0 0 auto; display: flex; justify-content: space-between; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 10px; }
      .header-left { display: flex; align-items: center; gap: 15px; }
      .print-logo { height: 60px; width: auto; object-fit: contain; }
      .title-block h1 { margin: 0; font-size: 24px; line-height: 1.2; color: #000; }
      .title-block h2 { margin: 0; font-size: 16px; font-weight: normal; color: #666; }
      .header-right { text-align: right; }
      .meta { font-size: 14px; margin-bottom: 2px; }
      .sub-meta { font-size: 11px; color: #888; margin-top: 4px; }
      .map-container { flex: 1; min-height: 0; display: flex; justify-content: center; align-items: center; overflow: hidden; }
      img.map-img { max-width: 100%; max-height: 100%; object-fit: contain; border: 1px solid #eee; }
    `

    // AGILITY
    if (store.sport === 'agility') {
      const dataUrl = stageRef.value.getStage().toDataURL({ pixelRatio: 3 })
      scale.value = originalScale 
      
      const win = window.open('', '_blank')
      win.document.write(`<!DOCTYPE html><html><head><title>${store.mapName}</title><style>${printStyles}</style></head><body><div class="print-page">${getHeader()}<div class="map-container"><img src="${dataUrl}" class="map-img"/></div></div></body></html>`)
      win.document.close()
      setTimeout(() => { win.focus(); win.print(); }, 500);
      return
    }

    // BARN HUNT (Multi-Page)
    // For printing, we temporarily toggle the layer view
    const originalLayer = store.currentLayer
    const images = []
    
    // We assume the caller handles the "Hide/Show" toggling of props if needed before calling this, 
    // or we can pass a callback. For now, we capture what is currently visible logic-wise.
    
    store.currentLayer = 1; await wait(150);
    images.push(stageRef.value.getStage().toDataURL({ pixelRatio: 3 }))
    
    store.currentLayer = 2; await wait(150);
    images.push(stageRef.value.getStage().toDataURL({ pixelRatio: 3 }))
    
    store.currentLayer = 3; await wait(150);
    images.push(stageRef.value.getStage().toDataURL({ pixelRatio: 3 }))

    store.currentLayer = originalLayer
    scale.value = originalScale

    const win = window.open('', '_blank')
    win.document.write(`
      <!DOCTYPE html>
      <html>
        <head><title>${store.mapName}</title><style>${printStyles}</style></head>
        <body>
          <div class="print-page">${getHeader('• Layer 1')}<div class="map-container"><img src="${images[0]}" class="map-img" /></div></div>
          <div class="print-page">${getHeader('• Layer 2')}<div class="map-container"><img src="${images[1]}" class="map-img" /></div></div>
          <div class="print-page">${getHeader('• Layer 3')}<div class="map-container"><img src="${images[2]}" class="map-img" /></div></div>
        </body>
      </html>
    `)
    win.document.close()
    setTimeout(() => { win.focus(); win.print(); }, 500);
  }

  return { handlePrint }
}