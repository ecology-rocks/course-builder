import { nextTick } from 'vue'

export function usePrinter(store, userStore, stageRef, scale) {

  async function handlePrint(withHides = true) {
    const originalScale = scale.value
    scale.value = 40 // Force standard print resolution
    await nextTick()
    const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms))
    await wait(100)

    const logoHtml = userStore.clubLogoUrl ? `<img src="${userStore.clubLogoUrl}" class="print-logo" />` : ''
    // Use Trial Location if available, else fallback
    const clubName = store.trialLocation || userStore.clubName
    const clubHtml = clubName ? `<div class="meta"><strong>Club:</strong> ${clubName}</div>` : ''

    // Shared Header
    const getSubtitle = (layerName) => {
      if (store.trialNumber || store.trialDay) {
        let text = `${store.classLevel}`
        if (store.trialNumber) text += ` Trial ${store.trialNumber}`
        if (store.trialDay) text += `, ${store.trialDay}`
        if (layerName) text += ` - ${layerName.replace('• ', '')}`
        return text
      } else {
        return `${store.classLevel} ${store.sport === 'agility' ? 'Agility' : 'Barn Hunt'} ${layerName || ''}`
      }
    }

    const getHeader = (subtitleSuffix = '') => `
      <div class="header">
        <div class="header-left">
          ${logoHtml}
          <div class="title-block">
            <h1>${store.mapName}</h1>
            <h2>${getSubtitle(subtitleSuffix)}</h2>
          </div>
        </div>
        <div class="header-right">
          <div class="meta"><strong>Judge:</strong> ${userStore.judgeName || '__________________'}</div>
          ${clubHtml}
          <div class="meta"><strong>Size:</strong> ${store.ringDimensions.width}' x ${store.ringDimensions.height}'</div>
          <div class="sub-meta">Generated by K9CourseBuilder.com</div>
        </div>
      </div>
    `

    // --- Diffs Helper ---
    const diffs = store.differentials
    const getDiffHtml = () => {
      if (!diffs) return ''

      const fmt = (l) => {
        const d = diffs[l]
        const sign = d.net > 0 ? '+' : ''
        const movedText = d.moved > 0 ? `, ${d.moved} moved` : '' 
        
        return `<div><strong>L${l}:</strong> ${sign}${d.net}${movedText}</div>`
      }

      return `
        <div class="legend-sub-section">
          <h4 style="margin-bottom: 2px;">Changes vs. Previous</h4>
          <div style="font-size: 10px; line-height: 1.2;">
            ${fmt(1)}
            ${fmt(2)}
            ${fmt(3)}
          </div>
        </div>
      `
    }

    // --- Legend HTML ---
    const getLegendHtml = () => `
      <div class="legend-sidebar">
        <h3>Legend</h3>
        
        <div class="legend-section">
          <h4>Statistics</h4>
          <div class="stats-grid">
            <div class="legend-item"><strong>Total: ${store.inventory.total}</strong></div>
            <div class="legend-item" style="color:#e6c200"><strong>L1:</strong> ${store.inventory.base}</div>
            <div class="legend-item" style="color:#4caf50"><strong>L2:</strong> ${store.inventory.layer2}</div>
            <div class="legend-item" style="color:#2196f3"><strong>L3:</strong> ${store.inventory.layer3}</div>
          </div>
          ${getDiffHtml()}
        </div>

        <div class="legend-section">
          <h4>Bales & Orientation</h4>
          <div class="legend-grid">
            <div class="legend-item"><span class="symbol layer-1"></span> L1 (Base)</div>
            <div class="legend-item"><span class="symbol flat"></span> Flat</div>
            
            <div class="legend-item"><span class="symbol layer-2"></span> L2</div>
            <div class="legend-item"><span class="symbol tall"></span> Tall</div>
            
            <div class="legend-item"><span class="symbol layer-3"></span> L3</div>
            <div class="legend-item"><span class="symbol pillar"></span> Pillar</div>
          </div>
        </div>

        <div class="legend-section">
          <h4>Features & Bounds</h4>
          <div class="legend-grid">
            <div class="legend-item"><span class="symbol fence"></span> Fence</div>
            <div class="legend-item"><span class="symbol wall"></span> Wall</div>
            
            <div class="legend-item"><span class="symbol tunnel"></span> Tunnel</div>
            <div class="legend-item"><span class="symbol leaner">↗</span> Leaner</div>
            
            <div class="legend-item"><span class="symbol start"></span> Start</div>
            <div class="legend-item"><span class="symbol dc"></span> DC Mat</div>
            
            <div class="legend-item full-width"><span class="symbol anchor">⚓</span> Anchor Bale</div>
          </div>
        </div>
        
        ${withHides ? `
        <div class="legend-section">
          <h4>Hides</h4>
          <div class="legend-grid">
            <div class="legend-item"><span class="symbol hide-rat">R</span> Rat</div>
            <div class="legend-item"><span class="symbol hide-litter">L</span> Litter</div>
            <div class="legend-item"><span class="symbol hide-empty">E</span> Empty</div>
          </div>
        </div>
        ` : ''}
      </div>
    `

    // --- CSS ---
    const printStyles = `
      @page { size: landscape; margin: 0.25in; }
      
      * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        color-adjust: exact !important;
      }

      html, body { margin: 0; padding: 0; width: 100%; height: 100%; }
      body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #333; }
      
      .print-page { height: 98vh; width: 100%; display: flex; flex-direction: column; break-after: page; page-break-after: always; }
      .print-page:last-child { break-after: auto; page-break-after: auto; }
      
      .header { flex: 0 0 auto; display: flex; justify-content: space-between; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 10px; }
      .header-left { display: flex; align-items: center; gap: 15px; }
      .print-logo { height: 60px; width: auto; object-fit: contain; }
      .title-block h1 { margin: 0; font-size: 24px; line-height: 1.2; color: #000; }
      .title-block h2 { margin: 0; font-size: 16px; font-weight: normal; color: #666; }
      .header-right { text-align: right; }
      .meta { font-size: 14px; margin-bottom: 2px; }
      .sub-meta { font-size: 11px; color: #888; margin-top: 4px; }

      /* Layout */
      .page-body { flex: 1; display: flex; min-height: 0; gap: 20px; }
      .map-container { flex: 1; display: flex; justify-content: center; align-items: flex-start; overflow: hidden; }
      img.map-img { max-width: 100%; max-height: 100%; object-fit: contain; border: 1px solid #eee; }

      /* Legend Styles - COMPACT MODE */
      .legend-sidebar { width: 175px; flex-shrink: 0; border-left: 1px solid #ccc; padding-left: 15px; font-size: 11px; }
      .legend-sidebar h3 { margin: 0 0 8px 0; font-size: 14px; text-transform: uppercase; border-bottom: 1px solid #333; display: inline-block; }
      
      .legend-section { margin-bottom: 10px; }
      .legend-section h4 { margin: 0 0 4px 0; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 1px solid #eee; }
      
      .legend-sub-section { border-top: 1px solid #ddd; padding-top: 4px; margin-top: 4px; }
      
      /* Grid Layouts for Compactness */
      .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2px 5px; }
      .legend-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2px 5px; }
      
      .legend-item { display: flex; align-items: center; gap: 6px; line-height: 1.2; font-size: 10px; }
      .full-width { grid-column: 1 / -1; }
      
      .symbol { display: inline-block; width: 16px; height: 10px; border: 1px solid black; position: relative; flex-shrink: 0; }
      
      /* Colors */
      .layer-1 { background: #e6c200; }
      .layer-2 { background: #4caf50; }
      .layer-3 { background: #2196f3; }
      
      /* Patterns for Orientation */
      .flat { background: #fff; }
      .tall { 
        background: linear-gradient(to bottom right, transparent 48%, black 49%, black 51%, transparent 52%); 
        background-color: #fff;
      }
      .pillar { 
        background: 
          linear-gradient(to bottom right, transparent 48%, black 49%, black 51%, transparent 52%),
          linear-gradient(to bottom left, transparent 48%, black 49%, black 51%, transparent 52%);
        background-color: #fff;
      }

      /* Items */
      .anchor { border: 2px solid #d32f2f; color: #d32f2f; font-weight: bold; text-align: center; line-height: 8px; font-size: 10px; border-radius: 2px; background: white; }
      .tunnel { height: 4px; background: #2e7d32; border: none; }
      .leaner { border: none; font-size: 12px; font-weight: bold; width: auto; height: auto; }
      .start { border: 1px dashed black; background: #eee; }
      .dc { background: #d1c4e9; }

      .fence { height: 1px; background: black; border: none; }
      .wall { height: 6px; background: black; border: none; }
      
      .hide-rat, .hide-litter, .hide-empty {
        width: 14px; 
        height: 14px; 
        border-radius: 50%; 
        border: 2px solid black;
        text-align: center; 
        line-height: 10px; 
        font-size: 9px; 
        font-weight: bold;
      }
      .hide-rat { background: red; color: black; }
      .hide-litter { background: yellow; color: black; }
      .hide-empty { background: white; color: black; }
    `

    // AGILITY
    if (store.sport === 'agility') {
      const dataUrl = stageRef.value.getStage().toDataURL({ pixelRatio: 3 })
      scale.value = originalScale

      const win = window.open('', '_blank')
      win.document.write(`<!DOCTYPE html><html><head><title>${store.mapName}</title><style>${printStyles}</style></head><body>
        <div class="print-page">
          ${getHeader()}
          <div class="page-body">
            <div class="map-container"><img src="${dataUrl}" class="map-img"/></div>
          </div>
        </div>
      </body></html>`)
      win.document.close()
      setTimeout(() => { win.focus(); win.print(); }, 500);
      return
    }

    // BARN HUNT
    const originalLayer = store.currentLayer
    const pages = []

    const shouldPrintLayer = (layerNum) => {
      if (layerNum === 1) return true
      return store.bales.some(b => b.layer === layerNum)
    }

    if (shouldPrintLayer(1)) {
      store.currentLayer = 1; await wait(150);
      pages.push({ title: '• Layer 1', img: stageRef.value.getStage().toDataURL({ pixelRatio: 3 }) })
    }

    if (shouldPrintLayer(2)) {
      store.currentLayer = 2; await wait(150);
      pages.push({ title: '• Layer 2', img: stageRef.value.getStage().toDataURL({ pixelRatio: 3 }) })
    }

    if (shouldPrintLayer(3)) {
      store.currentLayer = 3; await wait(150);
      pages.push({ title: '• Layer 3', img: stageRef.value.getStage().toDataURL({ pixelRatio: 3 }) })
    }

    store.currentLayer = originalLayer
    scale.value = originalScale

    const pagesHtml = pages.map(p => `
      <div class="print-page">
        ${getHeader(p.title)}
        <div class="page-body">
          <div class="map-container">
            <img src="${p.img}" class="map-img" />
          </div>
          ${getLegendHtml()}
        </div>
      </div>
    `).join('')

    const win = window.open('', '_blank')
    win.document.write(`
      <!DOCTYPE html>
      <html>
        <head><title>${store.mapName}</title><style>${printStyles}</style></head>
        <body>${pagesHtml}</body>
      </html>
    `)
    win.document.close()
    setTimeout(() => { win.focus(); win.print(); }, 500);
  }

  return { handlePrint }
}